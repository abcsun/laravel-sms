<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>sms  by abcsun</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">sms </h1>
      <h2 class="project-tagline">sms send package for laravel</h2>
      <a href="https://github.com/abcsun/laravel-sms" class="btn">View on GitHub</a>
      <a href="https://github.com/abcsun/laravel-sms/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/abcsun/laravel-sms/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="laravel-sms-for-laravel-5" class="anchor" href="#laravel-sms-for-laravel-5" aria-hidden="true"><span class="octicon octicon-link"></span></a>laravel-sms for laravel 5</h1>

<p><strong>使用场景</strong></p>

<ol>
<li>发送短信验证码。</li>
<li>发送信息通知短信(如：订单通知，发货通知，上课通知...)。</li>
<li>特殊情况下用户收不到短信？ laravel-sms提倡通过备用代理器机制使用两个及两个以上服务商。</li>
</ol>

<p><strong>该包特性</strong></p>

<ol>
<li>数据库记录/管理短信数据及其发送情况。</li>
<li>兼容模板短信和内容短信。</li>
<li>
<a href="https://github.com/toplan/laravel-sms#%E7%9F%AD%E4%BF%A1%E9%98%9F%E5%88%97">支持短信队列</a>。</li>
<li>
<a href="https://github.com/toplan/laravel-sms#%E5%A4%87%E7%94%A8%E4%BB%A3%E7%90%86%E5%99%A8%E6%9C%BA%E5%88%B6">备用代理器(服务商)机制</a>。即:如果用一个服务商发送短信失败，将会自动尝试通过预先设置的备用服务商发送。</li>
<li>集成<a href="https://github.com/toplan/laravel-sms#%E9%AA%8C%E8%AF%81%E7%A0%81%E7%9F%AD%E4%BF%A1%E6%A8%A1%E5%9D%97">验证码短信发送/校验模块</a>，分分钟搞定验证码短信发送以及手机号/验证码校验，
从此告别重复写验证码短信发送与校验的历史。</li>
<li>支持语音验证码，使用方法见特性5。</li>
<li>集成如下第三方短信服务商，你也可<a href="https://github.com/toplan/laravel-sms#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BB%A3%E7%90%86%E5%99%A8">自定义代理器</a>。</li>
</ol>

<table>
<thead>
<tr>
<th>服务商</th>
<th align="center">模板短信</th>
<th align="center">内容短信</th>
<th align="center">语音验证码</th>
<th align="center">最低消费</th>
<th align="center">最低消费单价</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://luosimao.com">Luosimao</a></td>
<td align="center">no</td>
<td align="center">yes</td>
<td align="center">yes</td>
<td align="center">￥850(1万条)</td>
<td align="center">￥0.085/条</td>
</tr>
<tr>
<td><a href="http://www.yunpian.com">云片网络</a></td>
<td align="center">no</td>
<td align="center">yes</td>
<td align="center">yes</td>
<td align="center">￥55(1千条)</td>
<td align="center">￥0.055/条</td>
</tr>
<tr>
<td><a href="http://www.yuntongxun.com">容联·云通讯</a></td>
<td align="center">yes</td>
<td align="center">no</td>
<td align="center">yes</td>
<td align="center">充值￥500</td>
<td align="center">￥0.055/条</td>
</tr>
<tr>
<td><a href="http://submail.cn">SUBMAIL</a></td>
<td align="center">yes</td>
<td align="center">no</td>
<td align="center">no</td>
<td align="center">￥100(1千条)</td>
<td align="center">￥0.100/条</td>
</tr>
<tr>
<td><a href="http://www.ucpaas.com/">云之讯</a></td>
<td align="center">yes</td>
<td align="center">no</td>
<td align="center">yes</td>
<td align="center"></td>
<td align="center">￥0.050/条</td>
</tr>
</tbody>
</table>

<h2>
<a id="安装" class="anchor" href="#%E5%AE%89%E8%A3%85" aria-hidden="true"><span class="octicon octicon-link"></span></a>安装</h2>

<p>在项目根目录下运行如下composer命令:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c">//安装稳定版本</span></span>
<span class="pl-s1">   <span class="pl-c1">composer</span> <span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>toplan/laravel-sms:~1.0.1<span class="pl-pds">'</span></span></span>
<span class="pl-s1"></span>
<span class="pl-s1">   <span class="pl-c">//安装开发中版本</span></span>
<span class="pl-s1">   <span class="pl-c1">composer</span> <span class="pl-k">require</span> <span class="pl-s"><span class="pl-pds">'</span>toplan/laravel-sms:dev-master<span class="pl-pds">'</span></span></span></pre></div>

<h2>
<a id="快速上手" class="anchor" href="#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B" aria-hidden="true"><span class="octicon octicon-link"></span></a>快速上手</h2>

<h4>
<a id="1注册服务提供器" class="anchor" href="#1%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E6%8F%90%E4%BE%9B%E5%99%A8" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.注册服务提供器</h4>

<p>在config/app.php文件中providers数组里加入：</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c">//laravel 5.0.*</span></span>
<span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>Toplan\Sms\SmsManagerServiceProvider<span class="pl-pds">'</span></span></span>
<span class="pl-s1">   <span class="pl-c">//laravel 5.1.*</span></span>
<span class="pl-s1">   <span class="pl-c1">Toplan\Sms\</span><span class="pl-c1">SmsManagerServiceProvider</span><span class="pl-k">::</span><span class="pl-c1">class</span></span></pre></div>

<p>在config/app.php文件中的aliases数组里加入</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c">//laravel 5.0.*</span></span>
<span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>SmsManager<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>Toplan\Sms\Facades\SmsManager<span class="pl-pds">'</span></span></span>
<span class="pl-s1">   <span class="pl-c">//laravel 5.1.*</span></span>
<span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>SmsManager<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">Toplan\Sms\Facades\</span><span class="pl-c1">SmsManager</span><span class="pl-k">::</span><span class="pl-c1">class</span></span></pre></div>

<h4>
<a id="2migration生成--参数配置" class="anchor" href="#2migration%E7%94%9F%E6%88%90--%E5%8F%82%E6%95%B0%E9%85%8D%E7%BD%AE" aria-hidden="true"><span class="octicon octicon-link"></span></a>2.migration生成 &amp; 参数配置</h4>

<ul>
<li>请先运行如下命令生成配置文件和migration文件</li>
</ul>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c1">php</span> <span class="pl-c1">artisan</span> <span class="pl-c1">vendor</span>:<span class="pl-c1">publish</span></span></pre></div>

<ul>
<li>在数据库中生成sms表</li>
</ul>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c1">php</span> <span class="pl-c1">artisan</span> <span class="pl-c1">migrate</span></span></pre></div>

<ul>
<li>
<p>设置默认代理器(服务商)</p>

<p>请在config/laravel-sms.php中设置默认代理服务商，默认为'Luosimao'。</p>
</li>
</ul>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>agent<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>Luosimao<span class="pl-pds">'</span></span>,</span></pre></div>

<ul>
<li>
<p>配置代理服务商的相关参数</p>

<p>在config/laravel-sms.php中，找到你想要使用的代理器，并填写好配置信息。</p>
</li>
</ul>

<blockquote>
<p>如果你使用的是Luosimao，请在数组'Luosimao'中按照提示填写配置信息</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">    <span class="pl-s"><span class="pl-pds">'</span>Luosimao<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> [</span>
<span class="pl-s1">         <span class="pl-k">...</span></span>
<span class="pl-s1">         <span class="pl-s"><span class="pl-pds">'</span>apikey<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>your api key<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">    ]</span></pre></div>
</blockquote>

<p>更多的服务商配置就不详说了，请到配置文件中查看并按提示修改相应代理服务商的配置。</p>

<h4>
<a id="3enjoy-it-使用sms模型发送短信" class="anchor" href="#3enjoy-it-%E4%BD%BF%E7%94%A8sms%E6%A8%A1%E5%9E%8B%E5%8F%91%E9%80%81%E7%9F%AD%E4%BF%A1" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.Enjoy it! 使用Sms模型发送短信</h4>

<p>在控制器中发送触发短信，如：</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">  <span class="pl-c">//只希望使用模板方式发送短信,可以不设置内容content (如云通讯,Submail)</span></span>
<span class="pl-s1">  <span class="pl-c1">Toplan\Sms\</span><span class="pl-c1">Sms</span><span class="pl-k">::</span>make(<span class="pl-smi">$tempId</span>)<span class="pl-k">-&gt;</span>to(<span class="pl-s"><span class="pl-pds">'</span>1828****349<span class="pl-pds">'</span></span>)<span class="pl-k">-&gt;</span>data([<span class="pl-s"><span class="pl-pds">'</span>12345<span class="pl-pds">'</span></span>, <span class="pl-c1">5</span>])<span class="pl-k">-&gt;</span>send();</span>
<span class="pl-s1"></span>
<span class="pl-s1">  <span class="pl-c">//只希望使用内容方式放送,可以不设置模板id和模板数据data (如云片,luosimao)</span></span>
<span class="pl-s1">  <span class="pl-c1">Toplan\Sms\</span><span class="pl-c1">Sms</span><span class="pl-k">::</span>make()<span class="pl-k">-&gt;</span>to(<span class="pl-s"><span class="pl-pds">'</span>1828****349<span class="pl-pds">'</span></span>)<span class="pl-k">-&gt;</span>content(<span class="pl-s"><span class="pl-pds">'</span>【Laravel SMS】亲爱的张三，欢迎访问，祝你工作愉快。<span class="pl-pds">'</span></span>)<span class="pl-k">-&gt;</span>send();</span>
<span class="pl-s1"></span>
<span class="pl-s1">  <span class="pl-c">//同时确保能通过模板和内容方式发送。这样做的好处是，可以兼顾到各种代理器(服务商)！</span></span>
<span class="pl-s1">  <span class="pl-c1">Toplan\Sms\</span><span class="pl-c1">Sms</span><span class="pl-k">::</span>make([</span>
<span class="pl-s1">      <span class="pl-s"><span class="pl-pds">'</span>YunTongXun<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>123<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">      <span class="pl-s"><span class="pl-pds">'</span>SubMail<span class="pl-pds">'</span></span>    <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>123<span class="pl-pds">'</span></span></span>
<span class="pl-s1">  ])</span>
<span class="pl-s1">  <span class="pl-k">-&gt;</span>to(<span class="pl-s"><span class="pl-pds">'</span>1828****349<span class="pl-pds">'</span></span>)</span>
<span class="pl-s1">  <span class="pl-k">-&gt;</span>data([<span class="pl-s"><span class="pl-pds">'</span>张三<span class="pl-pds">'</span></span>])</span>
<span class="pl-s1">  <span class="pl-k">-&gt;</span>content(<span class="pl-s"><span class="pl-pds">'</span>【签名】亲爱的张三，欢迎访问，祝你工作愉快。<span class="pl-pds">'</span></span>)</span>
<span class="pl-s1">  <span class="pl-k">-&gt;</span>send();</span></pre></div>

<h4>
<a id="4常用的语法糖" class="anchor" href="#4%E5%B8%B8%E7%94%A8%E7%9A%84%E8%AF%AD%E6%B3%95%E7%B3%96" aria-hidden="true"><span class="octicon octicon-link"></span></a>4.常用的语法糖</h4>

<ul>
<li>发送给谁</li>
</ul>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>to(<span class="pl-s"><span class="pl-pds">'</span>1828*******<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">   <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>to([<span class="pl-s"><span class="pl-pds">'</span>1828*******<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>1828*******<span class="pl-pds">'</span></span>, <span class="pl-k">...</span>]);<span class="pl-c">//多个目标号码</span></span></pre></div>

<ul>
<li>设置模板ID</li>
</ul>

<p>如果你只使用了默认代理器，即没有开启备用代理器机制。你只需要设置默认代理器的模板ID:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c">//静态方法设置，并返回sms实例</span></span>
<span class="pl-s1">   <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-c1">Toplan\Sms\</span><span class="pl-c1">Sms</span><span class="pl-k">::</span>make(<span class="pl-s"><span class="pl-pds">'</span>20001<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">   <span class="pl-c">//或</span></span>
<span class="pl-s1">   <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>template(<span class="pl-s"><span class="pl-pds">'</span>20001<span class="pl-pds">'</span></span>);</span></pre></div>

<p>如果你要开启备用代理器机制，那么需要为只支持模板短信默认/备用代理器设置相应模板ID，这样才能保证这些代理器正常使用。可以这样设置:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c">//静态方法设置，并返回sms实例</span></span>
<span class="pl-s1">   <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-c1">Toplan\Sms\</span><span class="pl-c1">Sms</span><span class="pl-k">::</span>make([<span class="pl-s"><span class="pl-pds">'</span>YunTongXun<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>20001<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>SubMail<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>xxx<span class="pl-pds">'</span></span>, <span class="pl-k">...</span>]);</span>
<span class="pl-s1">   <span class="pl-c">//设置指定服务商的模板id</span></span>
<span class="pl-s1">   <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>template(<span class="pl-s"><span class="pl-pds">'</span>YunTongXun<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>20001<span class="pl-pds">'</span></span>)<span class="pl-k">-&gt;</span>template(<span class="pl-s"><span class="pl-pds">'</span>SubMail<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>xxx<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1">   <span class="pl-c">//一次性设置多个服务商的模板id</span></span>
<span class="pl-s1">   <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>template([<span class="pl-s"><span class="pl-pds">'</span>YunTongXun<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>20001<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>SubMail<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>xxx<span class="pl-pds">'</span></span>, <span class="pl-k">...</span>]);</span></pre></div>

<ul>
<li>设置模板短信的模板数据</li>
</ul>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">  <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>data([</span>
<span class="pl-s1">        <span class="pl-s"><span class="pl-pds">'</span>code<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-smi">$code</span>,</span>
<span class="pl-s1">        <span class="pl-s"><span class="pl-pds">'</span>minutes<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-smi">$minutes</span></span>
<span class="pl-s1">      ]);<span class="pl-c">//must be array</span></span></pre></div>

<ul>
<li>
<p>设置内容短信的内容</p>

<p>有些服务商(如YunPian,Luosimao)只支持内容短信(即直接发送短信内容)，不支持模板，那么就需要设置短信内容。</p>
</li>
</ul>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">  <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>content(<span class="pl-s"><span class="pl-pds">'</span>【签名】亲爱的张三，您的订单号是281xxxx，祝你购物愉快。<span class="pl-pds">'</span></span>);</span></pre></div>

<ul>
<li>临时开启/关闭短信队列</li>
</ul>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">  <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>openQueue();<span class="pl-c">//开启队列,短信会在队列中排队</span></span>
<span class="pl-s1">  <span class="pl-smi">$sms</span> <span class="pl-k">=</span> <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>closeQueue();<span class="pl-c">//关闭队列,短信会直接发送</span></span></pre></div>

<ul>
<li>发送短信</li>
</ul>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">  <span class="pl-smi">$sms</span><span class="pl-k">-&gt;</span>send();<span class="pl-c">//return true or false</span></span></pre></div>

<h2>
<a id="短信队列" class="anchor" href="#%E7%9F%AD%E4%BF%A1%E9%98%9F%E5%88%97" aria-hidden="true"><span class="octicon octicon-link"></span></a>短信队列</h2>

<p>在config/laravel-sms中修改配置</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c">//开启队列为true, 关闭队列为false</span></span>
<span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>smsSendQueue<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">true</span>,</span></pre></div>

<p>如果你开启了队列，需要运行如下命名监听队列</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c1">php</span> <span class="pl-c1">artisan</span> <span class="pl-c1">queue</span>:<span class="pl-c1">listen</span></span></pre></div>

<h2>
<a id="备用代理器机制" class="anchor" href="#%E5%A4%87%E7%94%A8%E4%BB%A3%E7%90%86%E5%99%A8%E6%9C%BA%E5%88%B6" aria-hidden="true"><span class="octicon octicon-link"></span></a>备用代理器机制</h2>

<p>如果用一个服务商发送短信失败(如：欠费、频繁发送、发送次数上限、内容重复...)，将会自动尝试通过备用服务商发送。
  在config/laravel-sms.php中配置备用代理器</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">  <span class="pl-s"><span class="pl-pds">'</span>alternate<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> [</span>
<span class="pl-s1">      <span class="pl-c">//关闭备用代理器机制为false,打开为true</span></span>
<span class="pl-s1">      <span class="pl-s"><span class="pl-pds">'</span>enable<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">false</span>,</span>
<span class="pl-s1">      <span class="pl-c">//备用代理器组，排名分先后，越在前面的代理器会优先使用</span></span>
<span class="pl-s1">      <span class="pl-c">//example: ['YunPian', ...]</span></span>
<span class="pl-s1">      <span class="pl-s"><span class="pl-pds">'</span>agents<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> []</span>
<span class="pl-s1">  ],</span></pre></div>

<p>其中agents中如果有多个值，如：A,B,C。
  那么当默认代理器发送失败时，会自动启用A代理器，若A代理器发送失败，则会自动启用B，依次类推直到最后一个备用代理器。</p>

<h2>
<a id="验证码短信模块" class="anchor" href="#%E9%AA%8C%E8%AF%81%E7%A0%81%E7%9F%AD%E4%BF%A1%E6%A8%A1%E5%9D%97" aria-hidden="true"><span class="octicon octicon-link"></span></a>验证码短信模块</h2>

<p>可以直接访问example.com/sms/info查看该模块是否可用，并可在该页面里观察验证码短信发送数据，方便你进行调试。</p>

<h4>
<a id="1浏览器端请求发送带验证码短信" class="anchor" href="#1%E6%B5%8F%E8%A7%88%E5%99%A8%E7%AB%AF%E8%AF%B7%E6%B1%82%E5%8F%91%E9%80%81%E5%B8%A6%E9%AA%8C%E8%AF%81%E7%A0%81%E7%9F%AD%E4%BF%A1" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.[浏览器端]请求发送带验证码短信</h4>

<p>该包已经封装好浏览器端的jquery/zepto插件，只需要为发送按钮添加扩展方法即可实现发送短信。</p>

<div class="highlight highlight-text-html-basic"><pre>  //js文件在laravel-sms包的js文件夹中，请复制到项目资源目录
<span class="pl-s1">  &lt;<span class="pl-ent">script</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>/assets/js/jquery(zepto).laravel-sms.js<span class="pl-pds">"</span></span>&gt;&lt;/<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">  &lt;<span class="pl-ent">script</span>&gt;</span>
<span class="pl-s1">     <span class="pl-en">$</span>(<span class="pl-s"><span class="pl-pds">'</span>#sendVerifySmsButton<span class="pl-pds">'</span></span>).<span class="pl-en">sms</span>({</span>
<span class="pl-s1">        <span class="pl-c">//token value</span></span>
<span class="pl-s1">        token          <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">"</span>{{csrf_token()}}<span class="pl-pds">"</span></span>,</span>
<span class="pl-s1">        <span class="pl-c">//定义如何获取mobile的值</span></span>
<span class="pl-s1">        mobileSelector <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>input[name="mobile"]<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">        <span class="pl-c">//定义手机号的检测规则,当然你还可以到配置文件中自定义你想要的任何规则</span></span>
<span class="pl-s1">        mobileRule     <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>check_mobile_unique<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">        <span class="pl-c">//是否请求语音验证码</span></span>
<span class="pl-s1">        voice          <span class="pl-k">:</span> <span class="pl-c1">false</span>,</span>
<span class="pl-s1">        <span class="pl-c">//定义服务器有消息返回时如何展示，默认为alert</span></span>
<span class="pl-s1">        <span class="pl-en">alertMsg</span>       <span class="pl-k">:</span>  <span class="pl-k">function</span> (<span class="pl-smi">msg</span>, <span class="pl-smi">type</span>) {</span>
<span class="pl-s1">            <span class="pl-c1">alert</span>(msg);</span>
<span class="pl-s1">        },</span>
<span class="pl-s1">     });</span>
<span class="pl-s1">  &lt;/<span class="pl-ent">script</span>&gt;</span></pre></div>

<blockquote>
<p><strong>注意:</strong>
如果你使用Luosimao语音验证码，请在配置文件中'Luosimao'中设置'voiceApikey'。</p>
</blockquote>

<h4>
<a id="2服务器端配置短信内容模板" class="anchor" href="#2%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E9%85%8D%E7%BD%AE%E7%9F%AD%E4%BF%A1%E5%86%85%E5%AE%B9%E6%A8%A1%E6%9D%BF" aria-hidden="true"><span class="octicon octicon-link"></span></a>2.[服务器端]配置短信内容/模板</h4>

<p>配置文件: config/laravel-sms.php</p>

<ul>
<li>填写你的验证码短信内容或模板标示符</li>
</ul>

<blockquote>
<p>如果你使用的是内容短信(如云片网络,Luosimao)，则使用或修改'verifySmsContent'的值：</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>verifySmsContent<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>【填写签名】亲爱的用户，您的验证码是%s。有效期为%s分钟，请尽快验证<span class="pl-pds">'</span></span></span></pre></div>

<p>如果你使用模板短信(如云通讯,SubMail)，需要到相应代理器中填写模板标示符：</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>YunTongXun<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> [</span>
<span class="pl-s1">       <span class="pl-c">//模板标示符</span></span>
<span class="pl-s1">       <span class="pl-s"><span class="pl-pds">'</span>verifySmsTemplateId<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>your template id<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">   ]</span></pre></div>
</blockquote>

<ul>
<li>修改或自定义发送前检测规则</li>
</ul>

<blockquote>
<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>rules<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> [</span>
<span class="pl-s1">       <span class="pl-c">//唯一性检测规则</span></span>
<span class="pl-s1">       <span class="pl-s"><span class="pl-pds">'</span>check_mobile_unique<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>unique:users,mobile<span class="pl-pds">'</span></span>,<span class="pl-c">//适用于注册</span></span>
<span class="pl-s1">       <span class="pl-c">//存在性检测规则</span></span>
<span class="pl-s1">       <span class="pl-s"><span class="pl-pds">'</span>check_mobile_exists<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>exists:users<span class="pl-pds">'</span></span>,<span class="pl-c">//适用于找回密码和系统内业务验证</span></span>
<span class="pl-s1">   ]</span></pre></div>
</blockquote>

<h4>
<a id="3服务器端合法性验证" class="anchor" href="#3%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E5%90%88%E6%B3%95%E6%80%A7%E9%AA%8C%E8%AF%81" aria-hidden="true"><span class="octicon octicon-link"></span></a>3.[服务器端]合法性验证</h4>

<p>用户填写验证码并提交表单到服务器时，在你的控制器中需要验证手机号和验证码是否正确，你只需要加上如下代码即可：</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-c">//验证手机验证码</span></span>
<span class="pl-s1">   <span class="pl-smi">$validator</span> <span class="pl-k">=</span> <span class="pl-c1">Validator</span><span class="pl-k">::</span>make(<span class="pl-c1">Input</span><span class="pl-k">::</span>all(), [</span>
<span class="pl-s1">        <span class="pl-s"><span class="pl-pds">'</span>mobile<span class="pl-pds">'</span></span>     <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>required|mobile_changed<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">        <span class="pl-s"><span class="pl-pds">'</span>verifyCode<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>required|verify_code|verify_rule:check_mobile_unique<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">        <span class="pl-c">//more...</span></span>
<span class="pl-s1">   ]);</span>
<span class="pl-s1">   <span class="pl-k">if</span> (<span class="pl-smi">$validator</span><span class="pl-k">-&gt;</span>fails()) {</span>
<span class="pl-s1">       <span class="pl-c">//验证失败的话需要清除session数据，防止用户多次试错</span></span>
<span class="pl-s1">       <span class="pl-c1">\</span><span class="pl-c1">SmsManager</span><span class="pl-k">::</span>forgetSmsDataFromSession();</span>
<span class="pl-s1">       <span class="pl-k">return</span> redirect()<span class="pl-k">-&gt;</span>back()<span class="pl-k">-&gt;</span>withErrors(<span class="pl-smi">$validator</span>);</span>
<span class="pl-s1">   }</span></pre></div>

<p>PS:</p>

<ul>
<li>
<code>mobile_changed</code> 验证用户手机号是否合法。</li>
<li>
<code>verify_code</code> 验证验证码是否合法(验证码是否正确，是否超时无效)。</li>
<li>
<p><code>verify_rule:{$mobileRule}</code> 检测是否为非法请求，第一值为手机号检测规则，必须和你在浏览器端js插件中填写的mobileRule的值一致。</p>

<p><em>请在语言包中做好翻译。</em></p>
</li>
</ul>

<h2>
<a id="自助二次开发" class="anchor" href="#%E8%87%AA%E5%8A%A9%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91" aria-hidden="true"><span class="octicon octicon-link"></span></a>自助二次开发</h2>

<h4>
<a id="1自定义model" class="anchor" href="#1%E8%87%AA%E5%AE%9A%E4%B9%89model" aria-hidden="true"><span class="octicon octicon-link"></span></a>1.自定义Model</h4>

<p>继承model类(Toplan\Sms\Sms)</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">  <span class="pl-k">namespace</span> <span class="pl-en">App\Models</span>;</span>
<span class="pl-s1">  <span class="pl-k">class</span> <span class="pl-en">MySmsModel</span> <span class="pl-k">extends</span> <span class="pl-c1">Toplan\Sms\</span><span class="pl-e">Sms</span> {</span>
<span class="pl-s1">        <span class="pl-c">//override</span></span>
<span class="pl-s1">        <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">send</span>()</span>
<span class="pl-s1">        {</span>
<span class="pl-s1">            <span class="pl-c">//发送入口</span></span>
<span class="pl-s1">        }</span>
<span class="pl-s1">        <span class="pl-c">//override</span></span>
<span class="pl-s1">        <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">sendProcess</span>()</span>
<span class="pl-s1">        {</span>
<span class="pl-s1">            <span class="pl-c">//发送过程</span></span>
<span class="pl-s1">        }</span>
<span class="pl-s1">        <span class="pl-c">//more functions...</span></span>
<span class="pl-s1">  }</span></pre></div>

<p>修改model类后需要在配置文件中，修改key为'smsModel'的值：</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>smsModel<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>App\Models\MySmsModel<span class="pl-pds">'</span></span>,</span></pre></div>

<h2>
<a id="自定义代理器" class="anchor" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%BB%A3%E7%90%86%E5%99%A8" aria-hidden="true"><span class="octicon octicon-link"></span></a>自定义代理器</h2>

<p>欢迎贡献更多的代理器，这样就能支持更多第三方服务商的发送接口。请注意命名规范，Foo为代理器(服务商)名称。</p>

<p>配置项加入到src/config/laravel-sms.php中：</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-s"><span class="pl-pds">'</span>Foo<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> [</span>
<span class="pl-s1">        <span class="pl-s"><span class="pl-pds">'</span>verifySmsTemplateId<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>,</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-s"><span class="pl-pds">'</span>isResendFailedSmsInQueue<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-c1">false</span>,</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-s"><span class="pl-pds">'</span>xxx<span class="pl-pds">'</span></span> <span class="pl-k">=&gt;</span> <span class="pl-s"><span class="pl-pds">'</span>some info<span class="pl-pds">'</span></span>,</span>
<span class="pl-s1">        <span class="pl-k">...</span></span>
<span class="pl-s1">   ]</span></pre></div>

<p>在agents目录下添加代理器类(注意类名为FooAgent),并继承Agent抽象类。如果使用到其他api，可以将api文件放入src/lib文件夹中。</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1">   <span class="pl-k">namespace</span> <span class="pl-en">Toplan\Sms</span>;</span>
<span class="pl-s1">   <span class="pl-k">class</span> <span class="pl-en">FooAgent</span> <span class="pl-k">extends</span> <span class="pl-e">Agent</span> {</span>
<span class="pl-s1">        <span class="pl-c">//override</span></span>
<span class="pl-s1">        <span class="pl-c">//发送短信一级入口</span></span>
<span class="pl-s1">        <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">sendSms</span>(<span class="pl-smi">$tempId</span>, <span class="pl-smi">$to</span>, <span class="pl-k">Array</span> <span class="pl-smi">$data</span>, <span class="pl-smi">$content</span>){</span>
<span class="pl-s1">           <span class="pl-c">//在这个方法中调用二级入口</span></span>
<span class="pl-s1">           <span class="pl-c">//根据你使用的服务商的接口选择调用哪个方式发送短信</span></span>
<span class="pl-s1">           <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>sendContentSms(<span class="pl-smi">$to</span>, <span class="pl-smi">$content</span>);</span>
<span class="pl-s1">           <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span>sendTemplateSms(<span class="pl-smi">$tempId</span>, <span class="pl-smi">$to</span>, <span class="pl-k">Array</span> <span class="pl-smi">$data</span>);</span>
<span class="pl-s1">        }</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-c">//override</span></span>
<span class="pl-s1">        <span class="pl-c">//发送短信二级入口：发送内容短信</span></span>
<span class="pl-s1">        <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">sendContentSms</span>(<span class="pl-smi">$to</span>, <span class="pl-smi">$content</span>)</span>
<span class="pl-s1">        {</span>
<span class="pl-s1">            <span class="pl-c">//通过$this-&gt;config['key'],获取配置文件中的参数</span></span>
<span class="pl-s1">            <span class="pl-smi">$x</span> <span class="pl-k">=</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">config</span>[<span class="pl-s"><span class="pl-pds">'</span>xxx<span class="pl-pds">'</span></span>];</span>
<span class="pl-s1">            <span class="pl-smi">$x</span> <span class="pl-k">=</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">xxx</span>;<span class="pl-c">//也可以这样获取配置参数</span></span>
<span class="pl-s1">            <span class="pl-c">//在这里实现发送内容短信，即直接发送内容</span></span>
<span class="pl-s1">            <span class="pl-k">...</span></span>
<span class="pl-s1">            <span class="pl-c">//切记将发送结果存入到$this-&gt;result</span></span>
<span class="pl-s1">            <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">result</span>[<span class="pl-s"><span class="pl-pds">'</span>success<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> <span class="pl-c1">false</span>;<span class="pl-c">//是否发送成功</span></span>
<span class="pl-s1">            <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">result</span>[<span class="pl-s"><span class="pl-pds">'</span>info<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">currentAgentName</span> <span class="pl-k">.</span> <span class="pl-s"><span class="pl-pds">'</span>:<span class="pl-pds">'</span></span> <span class="pl-k">.</span> <span class="pl-s"><span class="pl-pds">'</span>发送结果说明<span class="pl-pds">'</span></span>;<span class="pl-c">//发送结果信息说明</span></span>
<span class="pl-s1">            <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">result</span>[<span class="pl-s"><span class="pl-pds">'</span>code<span class="pl-pds">'</span></span>] <span class="pl-k">=</span> <span class="pl-smi">$code</span>;<span class="pl-c">//发送结果代码</span></span>
<span class="pl-s1">        }</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-c">//override</span></span>
<span class="pl-s1">        <span class="pl-c">//发送短信二级入口：发送模板短信</span></span>
<span class="pl-s1">        <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">sendTemplateSms</span>(<span class="pl-smi">$tempId</span>, <span class="pl-smi">$to</span>, <span class="pl-k">Array</span> <span class="pl-smi">$data</span>)</span>
<span class="pl-s1">        {</span>
<span class="pl-s1">            <span class="pl-c">//同上...</span></span>
<span class="pl-s1">        }</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-c">//override</span></span>
<span class="pl-s1">        <span class="pl-c">//发送语音验证码</span></span>
<span class="pl-s1">        <span class="pl-k">public</span> <span class="pl-k">function</span> <span class="pl-en">voiceVerify</span>(<span class="pl-smi">$to</span>, <span class="pl-smi">$code</span>)</span>
<span class="pl-s1">        {</span>
<span class="pl-s1">            <span class="pl-c">//同上...</span></span>
<span class="pl-s1">            <span class="pl-c">//与发送短信唯一不同的是，切记返回结果数组</span></span>
<span class="pl-s1">            <span class="pl-k">return</span> <span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">result</span>;</span>
<span class="pl-s1">        }</span>
<span class="pl-s1">   }</span></pre></div>

<p>至此, 新加代理器成功!</p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>MIT</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/abcsun/laravel-sms">sms </a> is maintained by <a href="https://github.com/abcsun">abcsun</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
